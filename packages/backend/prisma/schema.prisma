

// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===== USER MANAGEMENT MODELS =====

model User {
  id          String      @id @default(cuid())
  address     String      @unique  // Wallet address
  email       String?     @unique  // From social login
  role        UserRole    @default(CONSUMER)
  status      UserStatus  @default(ACTIVE)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  profile              UserProfile?
  roleApplications     RoleApplication[]
  adminActionsPerformed AdminAction[] @relation("AdminUser")
  adminActionsReceived  AdminAction[] @relation("TargetUser")
  reviewedApplications RoleApplication[] @relation("AdminReviewer")
  
  // Conservation & Supply Chain Relations
  conservationRecords  ConservationRecord[]
  supplyChainRecords   SupplyChainRecord[]

  @@map("users")
}

model UserProfile {
  id              String   @id @default(cuid())
  userId          String   @unique
  firstName       String?
  lastName        String?
  organization    String?
  licenseNumber   String?
  phoneNumber     String?
  profileImage    String?  // IPFS hash
  bio             String?
  location        String?
  website         String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

model RoleApplication {
  id              String            @id @default(cuid())
  userId          String
  requestedRole   UserRole
  status          ApplicationStatus @default(PENDING)
  
  // Application Details
  organization    String?
  licenseNumber   String?
  businessType    String?
  experience      String?           // Years of experience
  motivation      String?           // Why they want this role
  
  // Documents (IPFS hashes)
  documents       String[]          // Array of IPFS hashes
  
  // Admin Review
  reviewedBy      String?           // Admin user ID
  adminFeedback   String?
  reviewedAt      DateTime?
  
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Relations
  user     User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  reviewer User? @relation("AdminReviewer", fields: [reviewedBy], references: [id])

  @@map("role_applications")
}


model AdminAction {
  id          String   @id @default(cuid())
  adminId     String   // Who performed the action
  targetId    String   // Who/what was affected
  action      String   // Action type (APPROVE_ROLE, REJECT_APPLICATION, etc.)
  description String?  // Detailed description
  metadata    Json?    // Additional action metadata
  createdAt   DateTime @default(now())

  // Relations
  admin  User @relation("AdminUser", fields: [adminId], references: [id])
  target User @relation("TargetUser", fields: [targetId], references: [id])

  @@map("admin_actions")
}

// ===== CONSERVATION MODULE MODELS =====

model ConservationRecord {
  id                   String   @id @default(cuid())
  samplingId           String   @unique  // Unique sampling identifier
  userId               String   // Researcher who created this record
  
  // Core Data (stored as JSON for flexibility)
  locationData         Json     // GPS, water body, environmental conditions
  speciesData          Json     // Species info, counts, measurements
  samplingData         Json     // Methods, duration, gear specs
  labTests             Json?    // Array of lab test results
  
  // File Management
  fileHashes           String[] // IPFS hashes of uploaded files
  
  // Additional Information
  researcherNotes      String?
  weatherConditions    String?
  tidalConditions      String?
  
  // Status and Verification
  status               String   @default("DRAFT")
  dataHash             String?  // IPFS hash of complete data
  blockchainHash       String?  // Blockchain transaction hash
  
  // Verification Info
  verifiedAt           DateTime?
  verifiedBy           String?  // Admin user ID who verified
  verificationNotes    String?
  
  // Timestamps
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  
  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Indexes for better performance
  @@index([userId])
  @@index([status])
  @@index([samplingId])
  @@index([createdAt])
  @@map("conservation_records")
}

// ===== SUPPLY CHAIN MODULE MODELS =====

model SupplyChainRecord {
  id                   String   @id @default(cuid())
  productId            String   @unique  // Unique product identifier
  userId               String   // User who created this record
  batchId              String?  // Batch identifier for grouping
  
  // Product Information
  sourceType           String   // FARMED or WILD_CAPTURE
  speciesName          String
  productName          String?
  productDescription   String?
  
  // Stage-specific Data (stored as JSON for flexibility)
  hatcheryData         Json?    // For farmed products
  growOutData          Json?    // For farmed products
  harvestData          Json?    // For both farmed and wild
  fishingData          Json?    // For wild capture
  processingData       Json?    // Processing stage
  distributionData     Json?    // Distribution/logistics
  retailData           Json?    // Retail stage
  
  // Current Status
  currentStage         String   // Current stage in the supply chain
  qrCodeData           String?  // QR code content
  
  // File Management
  fileHashes           String[] // IPFS hashes of uploaded files
  
  // Blockchain Integration
  dataHash             String?  // IPFS hash of complete data
  blockchainHash       String?  // Blockchain transaction hash
  
  // Status and Tracking
  status               String   @default("ACTIVE")
  isPublic             Boolean  @default(true)  // Can consumers trace this product?
  
  // Quality and Certifications
  qualityGrade         String?
  certifications       String[] // Array of certification names/numbers
  testResults          Json?    // Quality test results
  
  // Timestamps
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  
  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Indexes for better performance
  @@index([userId])
  @@index([productId])
  @@index([batchId])
  @@index([currentStage])
  @@index([sourceType])
  @@index([isPublic])
  @@index([createdAt])
  @@map("supply_chain_records")
}

// ===== ENUMS =====

enum UserRole {
  ADMIN
  RESEARCHER
  FARMER
  FISHERMAN
  PROCESSOR
  TRADER
  RETAILER
  CONSUMER
}

enum UserStatus {
  ACTIVE
  PENDING
  SUSPENDED
  REJECTED
}

enum ApplicationStatus {
  PENDING
  APPROVED
  REJECTED
}